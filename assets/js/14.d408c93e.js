(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{217:function(e,t,a){"use strict";a.r(t);var n=a(0),r=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"微信开发简要说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#微信开发简要说明","aria-hidden":"true"}},[e._v("#")]),e._v(" 微信开发简要说明")]),e._v(" "),a("h2",{attrs:{id:"一、关于openid和unionid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、关于openid和unionid","aria-hidden":"true"}},[e._v("#")]),e._v(" 一、关于Openid和UnionID")]),e._v(" "),a("p",[e._v("一个用户对多个公众号和应用有多个不同的OpenID，但只有一个UnionID。")]),e._v(" "),a("p",[e._v("开发前必读 - - "),a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信网页授权"),a("OutboundLink")],1)]),e._v(" "),a("h2",{attrs:{id:"二、如何在微信里登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、如何在微信里登录","aria-hidden":"true"}},[e._v("#")]),e._v(" 二、如何在微信里登录")]),e._v(" "),a("h3",{attrs:{id:"_2-1-关于access-token和refresh-token"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-关于access-token和refresh-token","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.1 关于access_token和refresh_token")]),e._v(" "),a("p",[e._v("使用手机号密码登录，服务端返回access_token和refresh_token，有效期分别为24小时和30天，前端保存至localStorage或者cookie里。用户点击菜单进入页面后")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("若access_token存在且有效，则认为已登录；")])]),e._v(" "),a("li",[a("p",[e._v("若access_token存在但失效，但refresh_token有效，则用refresh_token去服务端获取新的access_token；")])]),e._v(" "),a("li",[a("p",[e._v("若access_token、refresh_token不存在或者失效，重新进入手机号密码登录流程。")])])]),e._v(" "),a("h3",{attrs:{id:"_2-2-关于微信的静默授权和非静默授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-关于微信的静默授权和非静默授权","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.2 关于微信的静默授权和非静默授权")]),e._v(" "),a("p",[e._v("服务端提供的微信登录接口（例如"),a("a",{attrs:{href:"http://mock.hekr.me/project/112/interface/api/4225",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信登录"),a("OutboundLink")],1),e._v("），除常用的username、password、clientType、pid外，还有一个code（"),a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信说明"),a("OutboundLink")],1),e._v("），code由微信对网页进行授权而产生。")]),e._v(" "),a("p",[e._v("简要说明，有两种授权方式产生code，一种静默授权，一种非静默授权。")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("静默授权微信会自动跳转，用户无感知。H5从url中拿到code，传给服务端，服务端凭此可以拿到openid。")])]),e._v(" "),a("li",[a("p",[e._v("非静默授权的跳转，微信会显示授权页面，需要用户点击按钮才能进行下一步。H5从url中拿到code，传给服务端，服务端凭此可以拿到openid、unionid、微信用户名、微信头像。")])])]),e._v(" "),a("p",[e._v("如果服务端不需要“微信用户名”、“微信头像”这些信息，则H5采用静默授权即可。")]),e._v(" "),a("h3",{attrs:{id:"_2-3-h5登录流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-h5登录流程","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.3 H5登录流程")]),e._v(" "),a("p",[e._v("下面举例说明。")]),e._v(" "),a("p",[e._v("微信公众号菜单里，每一项可配置成一个url地址，一般使用前端地址，SPA同理路由不一样。")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("项目管理页面：http://a.cn/project.html")])]),e._v(" "),a("li",[a("p",[e._v("设备管理页面：http://a.cn/device.html")])]),e._v(" "),a("li",[a("p",[e._v("其它功能页面：http://a.cn/xxx.html ....")])]),e._v(" "),a("li",[a("p",[e._v("用户登录页面：http://a.cn/login.html")])])]),e._v(" "),a("p",[e._v("登录流程实现可全部放在login.html里。")]),e._v(" "),a("p",[e._v("用户点击菜单“项目管理”，微信浏览器进入：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("http://a.cn/project.html\n")])])]),a("p",[e._v("​\t|- - 1）页面检测需要登录，跳转到登录页：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('http://a.cn/login.html?backurl=A\n\n设定 A=urlencode("http://a.cn/project.html")\nbackurl作用是登录后，跳转到原来业务地址。\n')])])]),a("p",[e._v("​\t|- -2）先获取code，跳转到微信授权页面：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&redirect_uri=REDIRECT_URI&response_type=code&scope=SCOPE&state=STATE#wechat_redirect\n\n参数说明：\nAPPID即微信公众号APPID\nREDIRECT_URI为当前地址，REDIRECT_URI=urlencode(location.href)\nSCOPE，静默用snsapi_base，非静默用snsapi_userinfo。\nSTATE，为空即可，不是必须。\n\n示例：\nhttps://open.weixin.qq.com/connect/oauth2/authorize?appid=123456&redirect_uri=http%3a%2f%2fa.cn%2flogin.html%3fbackurl%3dhttp%253a%252f%252fa.cn%252fproject.html&response_type=code&scope=snsapi_base&state=#wechat_redirect\n")])])]),a("p",[e._v("​\t|- - 3）微信授权后，跳转回REDIRECT_URI（即第1步中的登录页）：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("http://a.cn/login.html?backurl=A&code=CODE&state=STATE\n")])])]),a("p",[e._v("​\t|- -4） js从url中拿到code，提示用户输入手机号和密码，向后台发起登录请求，后台返回access_token和refresh_token，保存。登录完成，跳转回业务页面A。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("http://a.cn/project.html\n")])])]),a("p",[e._v("​\t|- -5）正常执行业务页面功能。")]),e._v(" "),a("h3",{attrs:{id:"_2-4-服务端登录流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-服务端登录流程","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.4 服务端登录流程")]),e._v(" "),a("p",[e._v("服务端登录接口格式例子，参照“标准接口-消防行业产品”")]),e._v(" "),a("p",[a("a",{attrs:{href:"http://mock.hekr.me/project/112/interface/api/4225",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信登录"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"http://mock.hekr.me/project/112/interface/api/4270",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信签名"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("服务端收到H5发送的登录请求后，先对用户进行验证，然后根据code向微信服务器获取微信openid或者unionid，并记录到用户数据中。返回access_token和refresh_token。")]),e._v(" "),a("p",[e._v("根据code获取微信openid或者unionid，先换取网页授权access_token：")]),e._v(" "),a("p",[e._v("注意：此access_token与微信其它地方的access_token无任何关系。")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('GET https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code\n\n参数：\nAPPID和SECRET为公众号信息，CODE即为H5提交的code。\n\n返回：\n{ "access_token":"ACCESS_TOKEN",\n"expires_in":7200,\n"refresh_token":"REFRESH_TOKEN",\n"openid":"OPENID",\n"scope":"SCOPE" }\n')])])]),a("p",[e._v("若是静默授权，上面接口中即可拿到openid，流程结束。")]),e._v(" "),a("p",[e._v("若是非静默授权，需要拿到unionid和微信用户名等信息，继续请求：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('GET https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID&lang=zh_CN\n\n参数：\nACCESS_TOKEN和OPENID为上面接口中返回的。\n\n返回：\n{    "openid":" OPENID",\n" nickname": NICKNAME,\n"sex":"1",\n"province":"PROVINCE"\n"city":"CITY",\n"country":"COUNTRY",\n"headimgurl":"http://thirdwx.qlogo.cn/mmopen/4444/46",\n"privilege":[ "PRIVILEGE1" "PRIVILEGE2"     ],\n"unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"\n}\n')])])]),a("p",[e._v("注意：服务端需要支持一个手机号绑定不同的openid，但只能绑定一个，以最后一个为主。")]),e._v(" "),a("h2",{attrs:{id:"三、前端使用jssdk"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、前端使用jssdk","aria-hidden":"true"}},[e._v("#")]),e._v(" 三、前端使用JSSDK")]),e._v(" "),a("p",[e._v("微信H5开发时，需要用到扫一扫、选图片、位置信息、分享等功能，可以调用JSSDK，具体文档 - - "),a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信JS-SDK说明文档"),a("OutboundLink")],1)]),e._v(" "),a("h3",{attrs:{id:"_3-1-关于wx-config权限验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-关于wx-config权限验证","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.1 关于wx.config权限验证")]),e._v(" "),a("p",[e._v("使用JSSDK前，用户需要先登录拿到hekr的access_token。")]),e._v(" "),a("p",[e._v("在需要使用JSSDK的页面，引入js文件。")]),e._v(" "),a("p",[e._v("所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用。每一个url都需要调用一次，包括SPA。")]),e._v(" "),a("p",[e._v("js向服务端发起签名请求，"),a("a",{attrs:{href:"http://mock.hekr.me/project/112/interface/api/4270",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信签名"),a("OutboundLink")],1)]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#js注册JSSDK权限\nwx.config({\n    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。\n    appId: '', // 必填，公众号的唯一标识，\n    timestamp: , // 必填，生成签名的时间戳\n    nonceStr: '', // 必填，生成签名的随机串\n    signature: '',// 必填，签名\n    jsApiList: [] // 必填，需要使用的JS接口列表\n});\n\n参数：\nappId、timestamp、nonceStr、signature由签名请求返回。\njsApiList，按需填写，[JS接口列表](https://mp.weixin.qq.com/wiki?action=doc&id=mp1421141115&t=0.9605605998444211&token=&lang=zh_CN#63)\n")])])]),a("h2",{attrs:{id:"四、使用微信公众号开发测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、使用微信公众号开发测试","aria-hidden":"true"}},[e._v("#")]),e._v(" 四、使用微信公众号开发测试")]),e._v(" "),a("h3",{attrs:{id:"_4-1-微信测试号配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-微信测试号配置","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.1 微信测试号配置")]),e._v(" "),a("p",[e._v("由于公众号需要申请并认证，时间较长，开发测试阶段使用微信测试号，确认无误后再迁移到正式公众号上。")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login&token=&lang=zh_CN",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信测试号"),a("OutboundLink")],1),e._v("  每个人都可以申请测试号，扫码即可使用。测试号拥有正式号的所有功能，且无需单独申请。")]),e._v(" "),a("p",[e._v("对应的服务端可以使用生产环境或者预发环境，这里使用预发环境。")]),e._v(" "),a("p",[e._v("1）登录 "),a("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login&token=&lang=zh_CN",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信测试号"),a("OutboundLink")],1),e._v(" ，获取appID，appsecret，微信号。")]),e._v(" "),a("p",[e._v("2）登录test-console.hekr.me -> 产品设计平台 -> 微信控制，将appID、appsecret、微信号配置到对应中，“Token”随机填一字符串，“校验文件名”和“校验文件内容“随便填。记住”Token“和”回调地址“，下一步要使用。")]),e._v(" "),a("p",[e._v("3）微信测试号 -> 接口配置信息，将”Token“、”回调地址“填到此。")]),e._v(" "),a("p",[e._v("4）微信测试号 -> JS接口安全域名，域名使用本地IP，例如192.168.1.180，不用带端口。确保手机和电脑在同一个网段中，例如都是192或者10开头。")]),e._v(" "),a("p",[e._v("5）微信测试号 -> 体验接口权限表 -> 网页服务 -> 网页帐号 -> 修改，域名使用电脑本地IP，例如192.168.1.180:8080，如网页运行在80下，则端口不用带。")]),e._v(" "),a("p",[e._v("PC端开发测试可以使用"),a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1455784140",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信web开发者工具"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("h3",{attrs:{id:"_4-2-微信测试号配置菜单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-微信测试号配置菜单","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.2 微信测试号配置菜单")]),e._v(" "),a("p",[e._v("使用"),a("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/apiinfo",target:"_blank",rel:"noopener noreferrer"}},[e._v("接口调试工具"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("1）先获取access_token")]),e._v(" "),a("p",[e._v("2）自定义菜单-自定义菜单创建接口，body参考如下")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('{\n    "button": [\n        {\n            "type": "view", \n            "name": "项目管理", \n            "url": "http://192.168.1.180:8080/project.html"\n        }, \n        {\n            "type": "view", \n            "name": "设备管理", \n            "url": "http://192.168.1.180:8080/device.html"\n        }, \n        {\n            "type": "view", \n            "name": "我的", \n            "url": "http://192.168.1.180:8080/login.html"\n        }\n    ]\n}\n')])])]),a("h3",{attrs:{id:"_4-3-微信正式号配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-微信正式号配置","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.3 微信正式号配置")]),e._v(" "),a("p",[e._v("先申请微信服务号且通过企业认证，才能进行下面步骤。")]),e._v(" "),a("p",[e._v("前端项目的线上访问地址一般如下"),a("code",[e._v("https://hy.hekr.me/abcxxx/wechat/index.html")])]),e._v(" "),a("p",[e._v("1）微信后台 -> 设置 -> 公众号设置 -> 帐号详情，获取原始ID。")]),e._v(" "),a("p",[e._v("2）微信后台 -> 设置 -> 公众号设置 -> 功能设置。“JS接口安全域名”、“网页授权域名”填上"),a("code",[e._v("hy.hekr.me/abcxxx/wechat")]),e._v("。下载文件，例如“MP_verify_BlSeZtgK8Ya83gJ1.txt”，将文件集成到前端页面中，保证``https://hy.hekr.me/abcxxx/wechat/MP_verify_BlSeZtgK8Ya83gJ1.txt`可直接访问。")]),e._v(" "),a("p",[e._v("3）微信后台 -> 开发 -> 基本配置，获取AppId、AppSecret。")]),e._v(" "),a("p",[e._v("4）登录console.hekr.me -> 产品设计平台 -> 微信控制，将AppId、AppSecret、微信号(原始ID)配置到对应中，“Token”随机填一字符串，“校验文件名”、“校验文件内容“填"),a("code",[e._v("MP_verify_BlSeZtgK8Ya83gJ1.txt")]),e._v("及对应内容。记住”Token“和”回调地址“，下一步要使用。")]),e._v(" "),a("p",[e._v("5）微信后台 -> 开发 -> 基本配置 -> 服务器配置，将”Token“、”回调地址“填到此，明文模式。")]),e._v(" "),a("p",[e._v("6）微信后台 -> 功能 -> 自定义菜单，配置菜单地址。")]),e._v(" "),a("p",[e._v("7）微信后台 -> 开发 -> 开发者工具 -> web开发者工具，“开发者微信号”添加前端开发的微信，方便前端开发调试。")]),e._v(" "),a("p",[e._v("8）微信后台 -> 设置 -> 人员设置，添加自己为运营者，可避免下次登录微信后台需要管理员扫码。")]),e._v(" "),a("h2",{attrs:{id:"五、微信消息推送"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、微信消息推送","aria-hidden":"true"}},[e._v("#")]),e._v(" 五、微信消息推送")]),e._v(" "),a("p",[e._v("参考"),a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1433751277",target:"_blank",rel:"noopener noreferrer"}},[e._v("模板消息接口"),a("OutboundLink")],1),e._v("。")]),e._v(" "),a("p",[e._v("微信消息无法使用测试号测试，请直接使用正式号。")]),e._v(" "),a("h2",{attrs:{id:"六、相关参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、相关参考","aria-hidden":"true"}},[e._v("#")]),e._v(" 六、相关参考")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信公众平台技术文档"),a("OutboundLink")],1),e._v(" -- 开发必读！")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/apiinfo",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信公众平台接口调试工具"),a("OutboundLink")],1),e._v(" — 相当于postman，可获取accesstoken、设置菜单等。")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login&token=&lang=zh_CN",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信测试号"),a("OutboundLink")],1),e._v(" — 每个人都可申请，开发测试阶段使用测试号，然后再配置到正式公众号上。")]),e._v(" "),a("p",[a("a",{attrs:{href:"http://gitlab.hekr.me/front-end/wechat-login-example",target:"_blank",rel:"noopener noreferrer"}},[e._v("前端开发示例"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);